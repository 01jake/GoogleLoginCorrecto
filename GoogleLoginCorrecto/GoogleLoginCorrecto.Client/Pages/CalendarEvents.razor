@inject HttpClient Http
@inject NavigationManager NavManager
@using GoogleLoginCorrecto.Client;



@if (isLoading)
{
    <p><em>Cargando calendario...</em></p>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}
else
{

    <DxScheduler @bind-StartDate="@StartDate" DataStorage="@DataStorage" CssClass="w-100 h-100">
        <Views>
            <ComponenteCalendario />
        </Views>
    </DxScheduler>
}

@code {
    private bool isLoading = true;
    private string? errorMessage;

    private DateTime StartDate { get; set; } = DateTime.Today;
    private DxSchedulerDataStorage DataStorage { get; set; } = new DxSchedulerDataStorage();

    private record GoogleApiEvent(string Id, string Summary, DateTimeOffset? Start, DateTimeOffset? End);

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var baseUri = NavManager.BaseUri;
            var requestUri = new Uri(new Uri(baseUri), "api/calendar/events");
            var googleEvents = await Http.GetFromJsonAsync<GoogleApiEvent[]>(requestUri);

            if (googleEvents != null)
            {
                var appointments = googleEvents.Select(e => new Appointment
                    {
                        GoogleEventId = e.Id,
                        Subject = e.Summary,
                        StartDate = e.Start?.DateTime ?? DateTime.Today,
                        EndDate = e.End?.DateTime ?? e.Start?.DateTime.AddHours(1) ?? DateTime.Today.AddHours(1),
                        AllDay = e.Start.HasValue && e.End.HasValue && e.Start.Value.TimeOfDay == TimeSpan.Zero && (e.End.Value.Date - e.Start.Value.Date).Days == 1,
                        LabelId = 1,
                        StatusId = 1,
                        Description = "Evento de Google Calendar",

                    }).ToList();

                DataStorage = new DxSchedulerDataStorage()
                    {
                        AppointmentsSource = appointments,
                        AppointmentMappings = new DxSchedulerAppointmentMappings()
                        {
                            Start = nameof(Appointment.StartDate),
                            End = nameof(Appointment.EndDate),
                            Subject = nameof(Appointment.Subject),
                            AllDay = nameof(Appointment.AllDay),
                            LabelId = nameof(Appointment.LabelId),
                            StatusId = nameof(Appointment.StatusId),
                            Description = nameof(Appointment.Description),
                            Id = nameof(Appointment.GoogleEventId)
                        }
                    };
            }
            else
            {
                errorMessage = "No se encontraron eventos en el calendario.";
            }

        }


        catch (Exception ex)
        {
            errorMessage = $"Error al cargar los eventos: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
        StartDate = DateTime.Today;
        StateHasChanged();

    }

}